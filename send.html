<!doctype html>
<html><head><meta charset="utf-8"/><title>Phantom — Setup + Swap (SOL → USDC)</title><meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:system-ui,Arial;max-width:980px;margin:24px auto;padding:0 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd}
textarea{height:160px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
button{padding:10px 14px;border-radius:12px;border:1px solid #ddd;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
pre{white-space:pre-wrap;word-break:break-word;background:#f6f6f6;padding:12px;border-radius:12px}
.card{border:1px solid #eee;border-radius:16px;padding:14px;margin:12px 0}
.small{color:#666;font-size:13px} code{background:#f3f3f3;padding:2px 6px;border-radius:8px}
</style></head>
<body>
<h2>Phantom — Setup + Swap (SOL → USDC)</h2>
<div class="card"><div class="row">
<button id="connect">Connect Phantom</button>
<span class="small">Backend: <code id="backend"></code></span>
</div><p><b>Wallet:</b> <span id="wallet">not connected</span></p></div>

<div class="card">
<h3>1) Setup (Create ATAs + Wrap SOL into WSOL)</h3>
<label><b>Wrap amount (SOL)</b></label>
<input id="wrapSol" value="0.001"/>
<div class="row"><button id="doSetup" disabled>Build + Sign + Send Setup TX</button></div>
<p class="small">One-time setup. Creates USDC ATA + WSOL ATA if missing, then wraps SOL into WSOL.</p>
</div>

<div class="card">
<h3>2) Swap (WSOL → USDC)</h3>
<label><b>Swap amount (SOL)</b></label>
<input id="swapSol" value="0.001"/>
<label><b>Min out (USDC, optional)</b> <span class="small">(leave 0 to accept any)</span></label>
<input id="minOut" value="0"/>
<label class="small"><input type="checkbox" id="closeWsol" checked/> Close WSOL ATA after swap (unwrap leftovers)</label>
<div class="row"><button id="doSwap" disabled>Build + Sign + Send Swap TX</button></div>
<p class="small">Builds a Raydium CLMM swap (WSOL → USDC), simulates server-side, then Phantom signs+sends. Use <code>Min out</code> for protection.</p>
</div>

<div class="card">
<h3>Debug: send base64 tx</h3>
<textarea id="b64" placeholder="Paste base64 tx here (optional)"></textarea>
<div class="row"><button id="sendB64" disabled>Sign + Send Base64 TX</button></div>
</div>

<h3>Result</h3><pre id="out"></pre>

<script src="https://unpkg.com/@solana/web3.js@1.95.4/lib/index.iife.min.js"></script>
<script>
const out=(m)=>document.getElementById("out").textContent=String(m);
const walletEl=document.getElementById("wallet");
const backendEl=document.getElementById("backend");
const wrapSolEl=document.getElementById("wrapSol");
const swapSolEl=document.getElementById("swapSol");
const minOutEl=document.getElementById("minOut");
const closeWsolEl=document.getElementById("closeWsol");
const b64El=document.getElementById("b64");
const doSetupBtn=document.getElementById("doSetup");
const doSwapBtn=document.getElementById("doSwap");
const sendB64Btn=document.getElementById("sendB64");

function getProvider(){
  if(window.solana&&window.solana.isPhantom) return window.solana;
  if(window.phantom&&window.phantom.solana&&window.phantom.solana.isPhantom) return window.phantom.solana;
  return null;
}
let provider=null;

async function connect(){
  provider=getProvider();
  if(!provider) throw new Error("Phantom provider not found. Make sure Phantom is enabled and refresh.");
  const resp=await provider.connect();
  walletEl.textContent=resp.publicKey.toString();
  doSetupBtn.disabled=false; doSwapBtn.disabled=false; sendB64Btn.disabled=false;
  out("Connected.");
  return resp.publicKey.toString();
}
document.getElementById("connect").onclick=async()=>{try{await connect()}catch(e){out(e.message||e)}};

async function signAndSendTxBase64(b64){
  const txBytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const tx=solanaWeb3.Transaction.from(txBytes);
  const {signature}=await provider.signAndSendTransaction(tx);
  out("Sent! Signature:\n"+signature+"\n\nhttps://solscan.io/tx/"+signature);
  return signature;
}
async function postJson(path,obj){
  const resp=await fetch(path,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(obj)});
  const j=await resp.json();
  if(!j.ok) throw new Error((j.error||"Request failed")+(j.debug?"\n\n"+JSON.stringify(j.debug,null,2):""));
  return j;
}
doSetupBtn.onclick=async()=>{
  try{
    if(!provider||!provider.publicKey) await connect();
    const sol=Number(wrapSolEl.value);
    if(!Number.isFinite(sol)||sol<=0) throw new Error("Enter a positive wrap SOL amount (e.g. 0.001).");
    const wrapLamports=Math.floor(sol*1e9);
    out("Building setup tx...");
    const j=await postJson("/build-setup-tx",{userPublicKey:provider.publicKey.toString(),wrapLamports});
    out("Built setup tx. Opening Phantom...");
    await signAndSendTxBase64(j.tx);
  }catch(e){out(e.message||e)}
};
doSwapBtn.onclick=async()=>{
  try{
    if(!provider||!provider.publicKey) await connect();
    const sol=Number(swapSolEl.value);
    if(!Number.isFinite(sol)||sol<=0) throw new Error("Enter a positive swap SOL amount (e.g. 0.001).");
    const minOut=Number(minOutEl.value);
    if(!Number.isFinite(minOut)||minOut<0) throw new Error("Min out must be >= 0.");
    const amountInLamports=Math.floor(sol*1e9);
    const minAmountOutUsdc=Math.floor(minOut*1e6);
    out("Building swap tx (server will simulate first)...");
    const j=await postJson("/build-swap-tx",{userPublicKey:provider.publicKey.toString(),amountInLamports,minAmountOutUsdc,closeWsol:!!closeWsolEl.checked});
    out("Built swap tx. Opening Phantom...");
    await signAndSendTxBase64(j.tx);
  }catch(e){out(e.message||e)}
};
sendB64Btn.onclick=async()=>{
  try{
    if(!provider||!provider.publicKey) await connect();
    const b64=(b64El.value||"").trim();
    if(!b64) throw new Error("Paste base64 first.");
    await signAndSendTxBase64(b64);
  }catch(e){out(e.message||e)}
};
backendEl.textContent=location.origin;
</script>
</body></html>
